<!DOCTYPE html>
<html>
<head>
  <title>Integration test page</title>
</head>
<body>
<p id="title">Page for sending requests to request_recorder</p>

<script>
  var collector_endpoint = document.cookie.split('container=')[1].split(';')[0]
  document.body.className += ' loaded';
</script>

<script>
  function parseQuery() {
      var query = {};
      var pairs = window.location.search.substring(1).split('&');
      for (var i = 0; i < pairs.length; i++) {
          var pair = pairs[i].split('=');
          query[decodeURIComponent(pair[0])] = decodeURIComponent(pair[1] || '');
      }
      return query;
  }  
</script>

<script>

  ;(function(p,l,o,w,i,n,g){if(!p[i]){p.GlobalSnowplowNamespace=p.GlobalSnowplowNamespace||[];
    p.GlobalSnowplowNamespace.push(i);p[i]=function(){(p[i].q=p[i].q||[]).push(arguments)
    };p[i].q=p[i].q||[];n=l.createElement(o);g=l.getElementsByTagName(o)[0];n.async=1;
    n.src=w;g.parentNode.insertBefore(n,g)}}(window,document,"script","./snowplow.js","snowplow"));

  document.write(collector_endpoint)

  window.snowplow('newTracker', 'cf', collector_endpoint, {
    appId: 'CFe23a',
    platform: 'mob',
    eventMethod: parseQuery().eventMethod,
    contexts: {
      webPage: true
    },
  });

  window.snowplow('newTracker', 'b64off', collector_endpoint, {
    appId: 'no-b64',
    platform: 'web',
    eventMethod: parseQuery().eventMethod,
    encodeBase64: false,
  });

  // Add a global context
  var geolocationContext = {
    schema: 'iglu:com.snowplowanalytics.snowplow/geolocation_context/jsonschema/1-1-0',
    data: {
      'latitude': 40.0,
      'longitude' : 55.1
    }
  };

  function eventTypeContextGenerator(args) {
    var context = {};
    context['schema'] = 'iglu:com.snowplowanalytics.snowplow/mobile_context/jsonschema/1-0-1';
    context['data'] = {};
    context['data']['osType'] = 'ubuntu';
    context['data']['osVersion'] = '2018.04';
    context['data']['deviceManufacturer'] = 'ASUS';
    context['data']['deviceModel'] = String(args['eventType']);
    return context;
  }

  // A filter that will only attach contexts to structured events
  function structuredEventFilter(args) {
    return args['eventType'] === 'se';
  }

  function erroneousContextGenerator(args) {
    return {};
  }

  window.snowplow('enableGdprContext:cf', 'consent', 'someId', '0.1.0', 'this document is a test');

  window.snowplow('addGlobalContexts:cf', [erroneousContextGenerator]);
  window.snowplow('addGlobalContexts:cf', [[structuredEventFilter, [eventTypeContextGenerator, geolocationContext]]]);

  window.snowplow('setUserId:cf', 'Malcolm');

  // Also tracks to non-base64 encoding tracker
  window.snowplow('trackPageView:cf;b64off', 'My Title', [ // Set page title; add page context
    {
      schema: "iglu:org.schema/WebPage/jsonschema/1-0-0",
      data: {
        keywords: ['tester']
      }
    }
  ]);

  // This should have different pageViewId in web_page context
  window.snowplow('trackPageView:cf');

  window.snowplow('trackStructEvent:cf', 'Mixes', 'Play', 'MRC/fabric-0503-mix', '', '0.0');
  window.snowplow('trackUnstructEvent:cf', {
    schema: 'iglu:com.snowplowanalytics.snowplow/ad_impression/jsonschema/1-0-0',
    data: {
      bannerId: 'ASO01043'
    }
  }, [], {type: 'ttm', value: 1477401868});

  var orderId = 'order-123';

  window.snowplow('addTrans:cf',
    orderId,
    'acme',
    '8000',
    '100',
    '50',
    'phoenix',
    'arizona',
    'USA',
    'JPY'
  );

  // addItem might be called for each item in the shopping cart,
  // or not at all.
  window.snowplow('addItem:cf',
    orderId,
    '1001',
    'Blue t-shirt',
    'clothing',
    '2000',
    '2',
    'JPY'
  );

  // trackTrans sends the transaction to Snowplow tracking servers.
  // Must be called last to commit the transaction.
  window.snowplow('trackTrans:cf');

  var testAcceptRuleSet = {
    accept: ['iglu:com.snowplowanalytics.snowplow/*/jsonschema/*-*-*']
  };
  var testRejectRuleSet = {
    reject: ['iglu:com.snowplowanalytics.snowplow/*/jsonschema/*-*-*']
  };

  // test context rulesets
  window.snowplow('addGlobalContexts:cf', [[testAcceptRuleSet, [eventTypeContextGenerator, geolocationContext]]]);

  window.snowplow('trackUnstructEvent:cf', {
    schema: 'iglu:com.snowplowanalytics.snowplow/ad_impression/jsonschema/1-0-0',
    data: {
      bannerId: 'ASO01042'
    }
  }, [], {type: 'ttm', value: 1477401869});

  window.snowplow('removeGlobalContexts:cf', [[testAcceptRuleSet, [eventTypeContextGenerator, geolocationContext]]]);

  window.snowplow('addGlobalContexts:cf', [[testRejectRuleSet, [eventTypeContextGenerator, geolocationContext]]]);
  window.snowplow('trackUnstructEvent:cf', {
    schema: 'iglu:com.snowplowanalytics.snowplow/ad_impression/jsonschema/1-0-0',
    data: {
      bannerId: 'ASO01041'
    }
  }, [], {type: 'ttm', value: 1477401868});

  // track unhandled exception
  window.snowplow('enableErrorTracking:cf');

  // Test for exception handling
  function raiseException() {
    notExistentObject.notExistentProperty();
  }

  setTimeout(raiseException, 3000);

</script>

</body>
</html>
